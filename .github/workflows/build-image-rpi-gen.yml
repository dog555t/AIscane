name: Build and Release Receipt Scanner OS Image (rpi-image-gen)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: false
        default: 'latest'

env:
  IMAGE_NAME: receipt-scanner

jobs:
  build-image:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    permissions:
      contents: write  # Required to create releases and upload assets
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install rpi-image-gen
        run: |
          git clone --depth 1 https://github.com/raspberrypi/rpi-image-gen.git /tmp/rpi-image-gen
          cd /tmp/rpi-image-gen
          sudo ./install_deps.sh
          echo "/tmp/rpi-image-gen" >> $GITHUB_PATH
          
      - name: Verify rpi-image-gen installation
        run: |
          if ! command -v rpi-image-gen &> /dev/null; then
            echo "ERROR: rpi-image-gen not found in PATH"
            exit 1
          fi
          rpi-image-gen --help
      
      - name: Set up build environment
        run: |
          # Set release tag
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "RELEASE_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          else
            echo "RELEASE_TAG=${{ github.event.inputs.release_tag }}" >> $GITHUB_ENV
          fi
          
          # Set work directory
          echo "WORK_DIR=$GITHUB_WORKSPACE/work" >> $GITHUB_ENV
      
      - name: Build image
        run: |
          cd image-gen
          WORK_DIR="${{ env.WORK_DIR }}" ./build-image.sh
      
      - name: Prepare release artifacts
        run: |
          # Find the image directory
          IMAGE_DIR=$(find ${{ env.WORK_DIR }} -type d -name "image-*" -print -quit)
          
          if [ -z "$IMAGE_DIR" ] || [ ! -d "$IMAGE_DIR" ]; then
            echo "Error: Image directory not found"
            find ${{ env.WORK_DIR }} -type d -name "image-*" || true
            exit 1
          fi
          
          cd "$IMAGE_DIR"
          
          # Find the compressed image (use find instead of ls with glob)
          IMAGE_FILE=$(find . -maxdepth 1 -name "${{ env.IMAGE_NAME }}*.img.xz" -type f -print -quit)
          
          if [ -z "$IMAGE_FILE" ]; then
            echo "Error: No compressed image file found"
            ls -la
            exit 1
          fi
          
          # Remove leading ./ from filename
          IMAGE_FILE=$(basename "$IMAGE_FILE")
          
          # Verify file is readable
          if [ ! -r "$IMAGE_FILE" ]; then
            echo "Error: Image file is not readable: $IMAGE_FILE"
            ls -la "$IMAGE_FILE"
            exit 1
          fi
          
          # Verify checksums exist
          if [ ! -f "${IMAGE_FILE}.sha256" ]; then
            sha256sum "$IMAGE_FILE" > "${IMAGE_FILE}.sha256"
          fi
          
          if [ ! -f "SHA256SUM" ]; then
            sha256sum *.img.xz > SHA256SUM
          fi
          
          # Get image metadata
          IMAGE_SIZE=$(stat -c%s "$IMAGE_FILE")
          IMAGE_SIZE_MB=$((IMAGE_SIZE / 1024 / 1024))
          IMAGE_SHA256=$(sha256sum "$IMAGE_FILE" | cut -d' ' -f1)
          
          # Create release notes
          cat > RELEASE_NOTES.md << EOF
          # Receipt Scanner OS ${RELEASE_TAG}
          
          ## Overview
          Standalone Raspberry Pi OS image with receipt scanner pre-installed and configured.
          Built with **rpi-image-gen** for faster, more reliable builds.
          
          ## Features
          - ✅ Raspberry Pi AI Camera support with libcamera
          - ✅ Tesseract OCR for receipt text extraction
          - ✅ Built-in Wi-Fi hotspot (SSID: Receipt-Scanner, Password: receipt1234)
          - ✅ Web interface at http://192.168.4.1
          - ✅ SQLite and CSV data storage
          - ✅ Battery monitoring for UPS support
          - ✅ Automatic service startup on boot
          - ✅ Faster build system using pre-built packages
          
          ## Compatible Hardware
          - Raspberry Pi 5 (recommended)
          - Raspberry Pi 4
          - Raspberry Pi AI Camera Module
          - MakerFocus UPS Battery (optional)
          
          ## Installation
          
          ### Using Raspberry Pi Imager (Recommended)
          1. Download and install [Raspberry Pi Imager](https://www.raspberrypi.com/software/)
          2. Choose "Use custom" and select the downloaded \`.img.xz\` file
          3. Select your SD card and click "Write"
          4. Boot your Raspberry Pi with the flashed SD card
          
          ### Using Command Line
          \`\`\`bash
          # Download the image
          wget https://github.com/dog555t/AIscane/releases/download/${RELEASE_TAG}/${IMAGE_FILE}
          
          # Verify checksum (recommended)
          wget https://github.com/dog555t/AIscane/releases/download/${RELEASE_TAG}/${IMAGE_FILE}.sha256
          sha256sum -c ${IMAGE_FILE}.sha256
          
          # Extract and write to SD card (replace /dev/sdX with your SD card device)
          xzcat ${IMAGE_FILE} | sudo dd of=/dev/sdX bs=4M status=progress conv=fsync
          sync
          \`\`\`
          
          ## First Boot
          1. Insert the SD card and power on your Raspberry Pi
          2. Wait 1-2 minutes for initial boot and services to start
          3. Connect to Wi-Fi network "Receipt-Scanner" (password: receipt1234)
          4. Open browser and navigate to http://192.168.4.1
          5. Default OS login: username \`pi\`, password \`raspberry\`
          6. Default web app login: username \`admin\`, password \`admin123\`
          
          ⚠️ **Important**: Change both passwords immediately after first login!
          
          ## Image Details
          - **Filename**: ${IMAGE_FILE}
          - **Size**: ${IMAGE_SIZE_MB}MB compressed
          - **SHA256**: ${IMAGE_SHA256}
          - **Base**: Raspberry Pi OS Bookworm
          - **Build System**: rpi-image-gen
          - **Build Date**: $(date -u +"%Y-%m-%d")
          
          ## Security Notes
          ⚠️ **Important**: Change the default passwords after first login!
          
          **OS Password (SSH/console):**
          \`\`\`bash
          passwd
          \`\`\`
          
          **Web App Password:**
          - Login to web interface at http://192.168.4.1
          - Go to user menu → Change Password
          
          ## What's New in This Release
          - Migrated to rpi-image-gen for faster, more reliable builds
          - Simplified build configuration using YAML
          - Improved modularity with custom layers
          - Production-ready packages from official repositories
          - Better CI/CD integration
          
          ## Support
          - Issues: https://github.com/dog555t/AIscane/issues
          - Documentation: https://github.com/dog555t/AIscane/blob/main/README.md
          EOF
          
          echo "IMAGE_DIR=$IMAGE_DIR" >> $GITHUB_ENV
          echo "IMAGE_FILE=$IMAGE_FILE" >> $GITHUB_ENV
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'push' || github.event.inputs.release_tag != 'latest'
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Receipt Scanner OS ${{ env.RELEASE_TAG }}
          body_path: ${{ env.IMAGE_DIR }}/RELEASE_NOTES.md
          files: |
            ${{ env.IMAGE_DIR }}/${{ env.IMAGE_NAME }}*.img.xz
            ${{ env.IMAGE_DIR }}/${{ env.IMAGE_NAME }}*.img.xz.sha256
            ${{ env.IMAGE_DIR }}/SHA256SUM
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: receipt-scanner-image
          path: |
            ${{ env.IMAGE_DIR }}/${{ env.IMAGE_NAME }}*.img.xz
            ${{ env.IMAGE_DIR }}/*.sha256
            ${{ env.IMAGE_DIR }}/SHA256SUM
          retention-days: 7
